<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blackjack Trainer v6</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    background: #034c2c;
    font-family: Arial, sans-serif;
    color: white;
    margin: 0;
    padding: 20px;
    text-align: center;
  }

  h1 { margin-top: 10px; }

  .statsBar {
    max-width: 750px;
    margin: 8px auto 12px;
    padding: 10px;
    background: rgba(0,0,0,0.35);
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.4em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .table {
    background: #0a5a34;
    margin: 0 auto;
    padding: 20px;
    border-radius: 12px;
    max-width: 750px;
    box-shadow: 0 0 20px black;
  }

  .hand {
    margin: 10px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .card {
    width: 60px;
    height: 90px;
    background: white;
    color: black;
    border-radius: 8px;
    border: 2px solid #ddd;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    padding: 5px;
    font-size: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .red { color: red; }

  .label-line {
    font-size: 14px;
    margin-top: -4px;
    opacity: 0.9;
  }

  button {
    margin: 6px;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    background: gold;
    color: black;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    transition: opacity 0.3s ease;
  }

  button:disabled {
    opacity: 0.35;
    cursor: default;
  }

  .rules {
    margin-top: 20px;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
  }

  #rulesBody {
    max-height: 0;
    overflow: hidden;
    transition: max-height .3s ease;
  }

  #rulesBody.open {
    max-height: 600px;
    margin-top: 10px;
  }

  .rulesHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .plus {
    font-weight: bold;
    font-size: 22px;
  }
</style>
</head>

<body>

<h1>Blackjack Trainer</h1>

<div class="statsBar">
  <div>
    Hands: <strong id="handsCount">0</strong> &nbsp;
    Correct: <strong id="correctCount">0</strong> &nbsp;
    Mistakes: <strong id="mistakeCount">0</strong> &nbsp;
    Best streak: <strong id="bestStreak">0</strong> <br>
    Wins: <strong id="winsCount">0</strong> &nbsp;
    Losses: <strong id="lossesCount">0</strong> &nbsp;
    Win %: <strong id="winPercent">0%</strong>
  </div>
  <button onclick="downloadMistakes()">Download Mistakes (JSON)</button>
</div>

<div class="table">

  <h2>Dealer</h2>
  <div class="hand" id="dealerHand"></div>
  <p id="dealerTotal">Total: ?</p>

  <h2>You</h2>
  <div class="hand" id="playerHand"></div>
  <p id="playerTotal"></p>

  <p class="label-line" id="playerLabelLine"></p>

  <div>
    <button id="hitBtn" onclick="hit()">Hit</button>
    <button id="standBtn" onclick="stand()">Stand</button>
    <button id="doubleBtn" onclick="doubleDown()">Double</button>
    <button id="restartBtn" onclick="restart()">Restart</button>
  </div>

  <h3 id="result" style="height:20px; margin-top:10px;"></h3>

  <div id="rulesContainer" class="rules" style="display:none;" onclick="toggleRules(event)">
    <div class="rulesHeader">
      <strong>Why This Was the Correct Strategy</strong>
      <span id="plusSign" class="plus">+</span>
    </div>

    <div id="rulesBody">
      <div id="rulesText" style="padding:10px 0;"></div>
    </div>
  </div>

</div>

<script>

  const suits=["♠","♥","♦","♣"];
  const values=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const rankToNum={
    "A":11,"2":2,"3":3,"4":4,"5":5,"6":6,"7":7,"8":8,
    "9":9,"10":10,"J":10,"Q":10,"K":10
  };

  let deck=[];
  let player=[];
  let dealer=[];
  let gameOver=false;
  let playerAction=null;
  let firstMove=true;

  let totalHands=0;
  let correctDecisions=0;
  let mistakeDecisions=0;
  let bestStreak=0;
  let streak=0;

  let wins=0;
  let losses=0;

  let mistakesLog=[];

  function updateStatsDisplay(){
    document.getElementById("handsCount").innerText=totalHands;
    document.getElementById("correctCount").innerText=correctDecisions;
    document.getElementById("mistakeCount").innerText=mistakeDecisions;
    document.getElementById("bestStreak").innerText=bestStreak;

    updateWinStats();
  }

  function updateWinStats(){
    document.getElementById("winsCount").innerText=wins;
    document.getElementById("lossesCount").innerText=losses;

    const totalWL=wins+losses;
    if(totalWL===0) document.getElementById("winPercent").innerText="0%";
    else {
      const pct=(wins/totalWL*100).toFixed(1);
      document.getElementById("winPercent").innerText=pct+"%";
    }
  }

  function disableBtns(){
    document.getElementById("hitBtn").disabled=true;
    document.getElementById("standBtn").disabled=true;
    document.getElementById("doubleBtn").disabled=true;
  }

  function enableBtns(){
    document.getElementById("hitBtn").disabled=false;
    document.getElementById("standBtn").disabled=false;
    document.getElementById("doubleBtn").disabled=false;
  }

  function createDeck(){
    deck=[];
    suits.forEach(s=>values.forEach(v=>deck.push({suit:s,value:v})));
    deck.sort(()=>Math.random()-0.5);
  }

  function cardValue(c){ return rankToNum[c.value]; }

  function handTotal(hand){
    let total=hand.reduce((a,c)=>a+cardValue(c),0);
    let aces=hand.filter(c=>c.value==="A").length;
    while(total>21 && aces>0){ total-=10; aces--; }
    return total;
  }

  function isSoft(hand){
    let raw=hand.reduce((a,c)=>a+cardValue(c),0);
    let aces=hand.filter(c=>c.value==="A").length;
    while(raw>21 && aces>0){ raw-=10; aces--; }
    return hand.some(c=>c.value==="A") && raw<=21 && raw>=13;
  }

  function isPair(hand){ return hand.length===2 && hand[0].value===hand[1].value; }

  function dealInitial(){
    player=[deck.pop(),deck.pop()];
    dealer=[deck.pop(),deck.pop()];
    gameOver=false;
    playerAction=null;
    firstMove=true;
    enableBtns();
    updateUI();
    updateDouble();
  }

  function renderCard(c){
    const el=document.createElement("div");
    el.className="card "+((c.suit==="♥"||c.suit==="♦")?"red":"");
    el.innerHTML=`<div>${c.value}</div><div>${c.suit}</div>`;
    return el;
  }

  function updateDouble(){
    const btn=document.getElementById("doubleBtn");
    if(player.length===2 && firstMove && !gameOver)
      btn.style.display="inline-block";
    else btn.style.display="none";
  }

  function updateUI(){
    const dealerEl=document.getElementById("dealerHand");
    dealerEl.innerHTML="";
    dealerEl.appendChild(renderCard(dealer[0]));

    const hid=document.createElement("div");
    hid.className="card";
    hid.style.background="black";
    dealerEl.appendChild(hid);

    document.getElementById("dealerTotal").innerText="Total: ?";

    const p=document.getElementById("playerHand");
    p.innerHTML="";
    player.forEach(c=>p.appendChild(renderCard(c)));

    document.getElementById("playerTotal").innerText="Your total: "+handTotal(player);

    const up=dealer[0];
    document.getElementById("playerLabelLine").innerText =
      `Compare your first card ${player[0].value}${player[0].suit} `
      +`vs dealer's ${up.value}${up.suit}.`;

    document.getElementById("rulesContainer").style.display="none";
    document.getElementById("rulesBody").classList.remove("open");
    document.getElementById("plusSign").innerText="+";

    updateStatsDisplay();
  }

  function hit(){
    if(gameOver) return;
    playerAction="HIT";
    firstMove=false;
    player.push(deck.pop());
    updateDouble();

    if(handTotal(player)>=21) endHand();
    else renderPlayer();
  }

  function renderPlayer(){
    const p=document.getElementById("playerHand");
    p.innerHTML="";
    player.forEach(c=>p.appendChild(renderCard(c)));
    document.getElementById("playerTotal").innerText="Your total: "+handTotal(player);
  }

  function stand(){
    if(gameOver) return;
    playerAction="STAND";
    firstMove=false;
    dealerPlay();
  }

  function doubleDown(){
    if(gameOver||!firstMove||player.length!==2) return;
    playerAction="DOUBLE";
    firstMove=false;
    player.push(deck.pop());
    updateDouble();
    if(handTotal(player)>21) endHand();
    else dealerPlay();
  }

  function dealerPlay(){
    disableBtns();
    while(handTotal(dealer)<17){
      dealer.push(deck.pop());
    }
    setTimeout(endHand,150);
  }

  function endHand(){
    gameOver=true;
    disableBtns();

    const dealerEl=document.getElementById("dealerHand");
    dealerEl.innerHTML="";
    dealer.forEach(c=>dealerEl.appendChild(renderCard(c)));
    document.getElementById("dealerTotal").innerText="Total: "+handTotal(dealer);

    const pt=handTotal(player), dt=handTotal(dealer);
    let result="";
    if(pt>21){ result="You Busted!"; losses++; }
    else if(dt>21){ result="Dealer Busts! You Win!"; wins++; }
    else if(pt>dt){ result="You Win!"; wins++; }
    else if(dt>pt){ result="Dealer Wins!"; losses++; }
    else { result="Push (Tie)"; }

    document.getElementById("result").innerText=result;

    evaluateStrategy(pt,dt,result);
  }

  function basicStrategy(hand, up, first){
    const total=handTotal(hand);
    const upVal=cardValue(up);
    const pair=isPair(hand);
    const soft=isSoft(hand);

    function R(best,fallback){ return {best,fallback}; }

    if(first && pair){
      const v=hand[0].value;
      if(v==="A"||v==="8") return R("SPLIT","HIT");
      if(["10","J","Q","K"].includes(v)) return R("STAND","STAND");
      if(v==="5") return R("DOUBLE","HIT");
      if(v==="9"){
        if((upVal>=2&&upVal<=6)||upVal===8||upVal===9) return R("SPLIT","STAND");
        return R("STAND","STAND");
      }
      if(v==="2"||v==="3"){
        if(upVal>=2&&upVal<=7) return R("SPLIT","HIT");
        return R("HIT","HIT");
      }
      if(v==="4"){
        if(upVal===5||upVal===6) return R("SPLIT","HIT");
        return R("HIT","HIT");
      }
      if(v==="6"){
        if(upVal>=2&&upVal<=6) return R("SPLIT","HIT");
        return R("HIT","HIT");
      }
      if(v==="7"){
        if(upVal>=2&&upVal<=7) return R("SPLIT","HIT");
        return R("HIT","HIT");
      }
    }

    if(soft){
      if(total<=17){
        if(first && upVal>=3&&upVal<=6) return R("DOUBLE","HIT");
        return R("HIT","HIT");
      }
      if(total===18){
        if(first && upVal>=3&&upVal<=6) return R("DOUBLE","STAND");
        if([2,7,8].includes(upVal)) return R("STAND","STAND");
        return R("HIT","HIT");
      }
      if(total>=19) return R("STAND","STAND");
    }

    if(total<=8) return R("HIT","HIT");
    if(total===9){
      if(first&&upVal>=3&&upVal<=6) return R("DOUBLE","HIT");
      return R("HIT","HIT");
    }
    if(total===10){
      if(first&&upVal>=2&&upVal<=9) return R("DOUBLE","HIT");
      return R("HIT","HIT");
    }
    if(total===11){
      if(first&&up.value!=="A") return R("DOUBLE","HIT");
      return R("HIT","HIT");
    }
    if(total===12){
      if(upVal>=4&&upVal<=6) return R("STAND","STAND");
      return R("HIT","HIT");
    }
    if(total>=13&&total<=16){
      if(upVal>=2&&upVal<=6) return R("STAND","STAND");
      return R("HIT","HIT");
    }
    return R("STAND","STAND");
  }

  function evaluateStrategy(pt,dt,result){
    const expected=basicStrategy(player,dealer[0],true);
    const best=expected.best;
    const fallback=expected.fallback;

    let correct=(playerAction===best)||(best==="DOUBLE"&&playerAction===fallback);

    if(best==="SPLIT") correct=true;

    totalHands++;

    if(correct){
      correctDecisions++;
      streak++;
      bestStreak=Math.max(bestStreak,streak);
    } else {
      mistakeDecisions++;
      streak=0;

      mistakesLog.push({
        timestamp:new Date().toISOString(),
        playerCards:player.map(c=>c.value+c.suit),
        dealerCards:dealer.map(c=>c.value+c.suit),
        dealerUp:dealer[0].value+dealer[0].suit,
        action:playerAction,
        correctMove:best,
        fallbackMove:fallback,
        result,
        playerTotal:pt,
        dealerTotal:dt
      });
    }

    updateStatsDisplay();
    showExplanation(best,fallback,pt,dt,result);
  }

  function showExplanation(best,fallback,pt,dt,result){
    let text =
      `<p><strong>Your move:</strong> ${playerAction}</p>
       <p><strong>Basic Strategy recommends:</strong> ${best}
       ${best==="DOUBLE" ? "(or "+fallback+" if unavailable)" : ""}</p>
       <p><strong>Your total:</strong> ${pt} |
       <strong>Dealer total:</strong> ${dt}</p>
       <p>${result}</p>`;

    document.getElementById("rulesText").innerHTML=text;
    document.getElementById("rulesContainer").style.display="block";
  }

  function toggleRules(){
    const body=document.getElementById("rulesBody");
    const plus=document.getElementById("plusSign");
    if(body.classList.contains("open")){
      body.classList.remove("open");
      plus.innerText="+";
    } else {
      body.classList.add("open");
      plus.innerText="-";
    }
  }

  function downloadMistakes(){
    const blob=new Blob([JSON.stringify(mistakesLog,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="blackjack_mistakes.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function restart(){
    document.getElementById("result").innerText="";
    createDeck();
    dealInitial();
  }

  createDeck();
  dealInitial();

</script>

</body>
</html>